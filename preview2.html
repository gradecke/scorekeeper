<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scorekeeper</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #f2f2f7;
    --card: #ffffff;
    --text: #111;
    --muted: #6b6b70;
    --border: #d0d0d6;
    --primary: #007AFF;
    --danger: #ff3b30;
  }

  @media (prefers-color-scheme: dark){
    :root{
      --bg: #000000;
      --card: #1c1c1e;
      --text: #f2f2f7;
      --muted: #a9a9ae;
      --border: #303034;
      --primary: #0a84ff;
      --danger: #ff453a;
    }
  }

  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, system-ui, sans-serif;
    margin: 0;
    padding: 16px;
    background: var(--bg);
    color: var(--text);
    max-width: 820px;
    margin-left: auto;
    margin-right: auto;
  }

  h1{ text-align:center; margin: 6px 0 14px; font-size:20px; }

  .card{
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    margin-bottom: 14px;
    border: 1px solid rgba(0,0,0,0.02);
  }

  /* Top bar with Actions + theme toggle */
  .topbar {
    display:flex;
    justify-content:flex-end;
    gap: 8px;
    align-items:center;
    margin-bottom: 8px;
  }

  .btn {
    background: var(--primary);
    color: white;
    padding: 10px 12px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 15px;
  }

  .icon-btn {
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 16px;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }

  .actions-container { position: relative; display:inline-block; }

  .actions-menu {
    position: absolute;
    right: 0;
    top: 44px;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    border-radius: 10px;
    min-width: 220px;
    z-index: 120;
    padding: 8px;
  }
  .actions-menu button { 
    display:block; 
    width:100%; 
    background: transparent; 
    border: none; 
    padding: 10px 8px; 
    text-align:left; 
    color: var(--text); 
    border-radius:8px;
    font-weight:600;
  }
  .actions-menu button:hover{ background: rgba(0,0,0,0.04); }

  /* Player setup */
  #playerInputs .player-input-row { margin-bottom:10px; }
  input.player-name {
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size:15px;
  }

  .table {
    width:100%;
    border-collapse:collapse;
  }

  .table th, .table td {
    padding: 10px 8px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .table th {
    font-size: 14px;
    font-weight: 700;
    text-align: left;
    cursor: default;
  }

  .col-name { width: 55%; }
  .col-input { width: 25%; text-align:center; }
  .col-total { width: 20%; text-align:right; }

  .numeric-input {
    width: 84px;
    padding:8px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:15px;
    text-align:center;
  }

  .color-dot {
    width:12px;
    height:12px;
    border-radius:50%;
    display:inline-block;
    margin-right:8px;
    vertical-align: middle;
  }

  .sort-icon {
    margin-left:8px;
    font-weight:800;
    color: var(--muted);
    font-size:14px;
    cursor: pointer;
  }

  /* Chart container: height rules */
  .chart-wrap {
    height: 40vh;     /* default */
    max-height: 50vh; /* cap to half screen */
    min-height: 180px;
    margin-top: 12px;
    overflow: hidden;
    position: relative;
  }
  canvas { width:100% !important; height:100% !important; display:block; }

  /* small screens adjustments */
  @media (max-width:420px){
    .col-name{ width: 60%; }
    .col-input{ width: 25%; }
    .col-total{ width: 15%; font-size:14px; }
    .numeric-input{ width:70px; padding:6px; }
  }

  /* subtle footer note */
  .muted { color: var(--muted); font-size:13px; margin-top:6px; }
</style>
</head>
<body>

<h1>Scorekeeper</h1>

<!-- topbar: actions + theme toggle -->
<div class="topbar">
  <div class="actions-container">
    <button class="icon-btn" onclick="toggleActions()">Actions â–¾</button>
    <div id="actionsMenu" class="actions-menu" style="display:none;">
      <button onclick="confirmNewGame()">New Game (Same Players)</button>
      <button onclick="confirmReset()">Reset (New Players)</button>
    </div>
  </div>

  <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">ðŸŒ™</button>
</div>

<!-- Setup -->
<div id="setup" class="card">
  <div id="playerInputs">
    <!-- JS will add rows here -->
  </div>

  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn" style="flex:1" onclick="addPlayerInput()">Add Player</button>
    <button class="btn" style="flex:1; background:var(--primary);" onclick="startGame()">Start Game</button>
  </div>
  <div class="muted">Tip: Add player names, then press Start Game. Add at least one player.</div>
</div>

<!-- Game panel -->
<div id="game" class="card" style="display:none;">
  <table class="table" role="table" aria-label="Players table">
    <thead>
      <tr>
        <th class="col-name">Name
          <span id="nameSort" class="sort-icon" onclick="toggleSort('name')">â†“</span>
        </th>
        <th class="col-input">Points</th>
        <th class="col-total">Total
          <span id="scoreSort" class="sort-icon" onclick="toggleSort('score')">â†“</span>
        </th>
      </tr>
    </thead>
    <tbody id="playerRows"></tbody>
  </table>

  <div style="margin-top:10px;">
    <button class="btn" onclick="submitPoints()">Add Points</button>
  </div>

  <div class="chart-wrap card" style="margin-top:12px; padding:10px;">
    <canvas id="scoreChart"></canvas>
  </div>
</div>

<script>
/* ------------------------------
   Configuration / hardcoded colors
   ------------------------------ */
const COLORS = [
  "#007AFF", // 1
  "#FF3B30", // 2
  "#34C759", // 3
  "#AF52DE", // 4
  "#FF9500", // 5
  "#5AC8FA"  // 6
];

let players = [];        // order of creation
let scores = {};         // { name: total }
let history = [];        // array of arrays: each snapshot is players.map(p => scores[p])
let sortMode = "score-desc"; // default
let chart = null;
let savedTheme = null;

/* ------------------------------
   Helpers: storage & theme
   ------------------------------ */
function saveState(){
  const state = { players, scores, history, sortMode, theme: savedTheme };
  try { localStorage.setItem("scorekeeper_state", JSON.stringify(state)); } catch(e){}
}

function loadState(){
  try{
    const raw = localStorage.getItem("scorekeeper_state");
    if(!raw) return false;
    const s = JSON.parse(raw);
    if(!s.players) return false;
    players = s.players || [];
    scores = s.scores || {};
    history = s.history || [];
    sortMode = s.sortMode || "score-desc";
    savedTheme = s.theme || null;
    return true;
  }catch(e){
    return false;
  }
}

/* Apply theme: 'dark'|'light'|null(auto)
   savedTheme === 'dark' forces dark, ==='light' forces light, null follows system */
function applyTheme(){
  const html = document.documentElement;
  if(savedTheme === 'dark'){
    html.style.colorScheme = 'dark';
    document.getElementById('themeToggle').textContent = 'â˜€ï¸';
  } else if(savedTheme === 'light'){
    html.style.colorScheme = 'light';
    document.getElementById('themeToggle').textContent = 'ðŸŒ™';
  } else {
    // auto: follow prefers-color-scheme
    const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.getElementById('themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    html.style.colorScheme = isDark ? 'dark' : 'light';
  }
}

/* Toggle theme button handler */
document.getElementById('themeToggle').addEventListener('click', () => {
  if(savedTheme === 'dark') savedTheme = 'light';
  else if(savedTheme === 'light') savedTheme = null;
  else savedTheme = 'dark';
  applyTheme();
  saveState();
});

/* ------------------------------
   Actions menu toggle
   ------------------------------ */
function toggleActions(){
  const m = document.getElementById('actionsMenu');
  m.style.display = m.style.display === 'block' ? 'none' : 'block';
}
document.addEventListener('click', e => {
  if(!e.target.closest('.actions-container') && !e.target.closest('#actionsMenu') && !e.target.closest('button.icon-btn')) {
    document.getElementById('actionsMenu').style.display = 'none';
  }
});

/* ------------------------------
   Player input UI (setup)
   ------------------------------ */
function addPlayerInput(name = ''){
  const container = document.getElementById('playerInputs');
  const row = document.createElement('div');
  row.className = 'player-input-row';
  row.innerHTML = `<input class="player-name" placeholder="Player name" value="${escapeHtml(name)}">`;
  container.appendChild(row);
}

/* Escape helper for values inserted into HTML */
function escapeHtml(s = ''){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ------------------------------
   Start game
   ------------------------------ */
function startGame(){
  const inputs = document.querySelectorAll('.player-name');
  players = [];
  scores = {};
  history = [];

  inputs.forEach((inp, i) => {
    const n = inp.value.trim();
    if(n){
      players.push(n);
      scores[n] = 0;
    }
  });

  if(players.length === 0){
    alert('Please add at least one player name.');
    return;
  }

  document.getElementById('setup').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  renderPlayerRows();
  updateAll();
  saveState();
}

/* ------------------------------
   Render player rows (sorted for display only)
   ------------------------------ */
function renderPlayerRows(){
  const tbody = document.getElementById('playerRows');
  tbody.innerHTML = '';

  const displayOrder = sortedPlayers();

  displayOrder.forEach((p, displayIndex) => {
    const origIndex = players.indexOf(p);
    const color = COLORS[origIndex % COLORS.length];

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-name">
        <span class="color-dot" style="background:${color}"></span>
        <span style="vertical-align:middle">${escapeHtml(p)}</span>
      </td>
      <td class="col-input">
        <input id="points-${encodeId(p)}" class="numeric-input" inputmode="numeric" pattern="[0-9]*" placeholder="0">
      </td>
      <td class="col-total" id="total-${encodeId(p)}">${scores[p]}</td>
    `;
    tbody.appendChild(tr);
  });

  // update sort icons
  const scoreIcon = document.getElementById('scoreSort');
  const nameIcon = document.getElementById('nameSort');
  if(sortMode === 'score-desc'){ scoreIcon.textContent = 'â†“'; nameIcon.textContent = 'â†“'; }
  else if(sortMode === 'score-asc'){ scoreIcon.textContent = 'â†‘'; nameIcon.textContent = 'â†“'; }
  else if(sortMode === 'name-asc'){ nameIcon.textContent = 'â†‘'; scoreIcon.textContent = 'â†“'; }
  else if(sortMode === 'name-desc'){ nameIcon.textContent = 'â†“'; scoreIcon.textContent = 'â†“'; }
}

/* encodeId to produce valid element IDs from names */
function encodeId(s){ return btoa(unescape(encodeURIComponent(s))).replace(/=/g,''); }

/* ------------------------------
   Sorting logic (display only)
   ------------------------------ */
function sortedPlayers(){
  return players.slice().sort((a,b) => {
    if(sortMode === 'score-desc') return scores[b] - scores[a];
    if(sortMode === 'score-asc') return scores[a] - scores[b];
    if(sortMode === 'name-asc') return a.localeCompare(b);
    if(sortMode === 'name-desc') return b.localeCompare(a);
    return 0;
  });
}

/* toggleSort: separate toggles for name and score */
function toggleSort(col){
  if(col === 'score'){
    sortMode = (sortMode === 'score-desc') ? 'score-asc' : 'score-desc';
  } else if(col === 'name'){
    sortMode = (sortMode === 'name-asc') ? 'name-desc' : 'name-asc';
  }
  renderPlayerRows();
  updateTotals();
  saveState();
}

/* ------------------------------
   Submit points (new round)
   ------------------------------ */
function submitPoints(){
  const snapshot = [];
  players.forEach(p => {
    const el = document.getElementById(`points-${encodeId(p)}`);
    let raw = '';
    if(el) raw = el.value.trim();
    const val = (raw === '' || isNaN(parseInt(raw))) ? 0 : parseInt(raw,10);
    scores[p] = (scores[p] || 0) + val;
    if(el) el.value = '';
    snapshot.push(scores[p]);
  });

  // push snapshot (cumulative totals per player in players[] order)
  history.push(snapshot);
  updateAll();
  saveState();
}

/* ------------------------------
   Update totals & chart
   ------------------------------ */
function updateTotals(){
  players.forEach(p => {
    const td = document.getElementById(`total-${encodeId(p)}`);
    if(td) td.textContent = scores[p];
  });
}

function updateChart(){
  const ctx = document.getElementById('scoreChart').getContext('2d');

  // labels: Round 1, Round 2, ...
  const labels = history.map((_,i) => `Round ${i+1}`);

  // datasets in the original players order (stable)
  const datasets = players.map((p, idx) => {
    const color = COLORS[idx % COLORS.length];
    // for each history snapshot, the value at position idx is the cumulative total for this player
    const data = history.map(snapshot => {
      // snapshot is array aligned with players[] order
      return snapshot[idx] ?? 0;
    });
    return {
      label: p,
      data,
      borderColor: color,
      backgroundColor: color + '33',
      borderWidth: 2.5,
      pointRadius: 4,
      tension: 0.25
    };
  });

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') || '#000' } }
      },
      scales: {
        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') || '#000' } },
        y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') || '#000' }, beginAtZero: true }
      }
    }
  });
}

/* updateAll: refresh UI and chart */
function updateAll(){
  renderPlayerRows();
  updateTotals();
  if(history.length > 0) updateChart();
}

/* ------------------------------
   New game / reset (confirmations)
   ------------------------------ */
function confirmNewGame(){
  const ok = confirm('Start a new game with the same players? This will reset totals and history but keep player names.');
  if(!ok) return;
  players.forEach(p => scores[p] = 0);
  history = [];
  updateAll();
  saveState();
}

function confirmReset(){
  const ok = confirm('Reset everything and return to player setup? This will clear players, scores and history.');
  if(!ok) return;
  localStorage.removeItem('scorekeeper_state');
  location.reload();
}

/* ------------------------------
   Initialization: add 2 default inputs, load state if present
   ------------------------------ */
function init(){
  // Add two blank player inputs if none exist (setup)
  if(!loadState()){
    addPlayerInput('');
    addPlayerInput('');
  } else {
    // loaded state: if players exist, go directly to game
    if(players && players.length > 0){
      // ensure scores object has keys for players
      players.forEach((p,idx) => { if(scores[p] === undefined) scores[p] = 0; });
      document.getElementById('setup').style.display = 'none';
      document.getElementById('game').style.display = 'block';
    } else {
      addPlayerInput('');
      addPlayerInput('');
    }
  }

  applyTheme();
  renderPlayerRows();
  if(history.length > 0) updateChart();

  // Add event listeners for Enter key on points inputs (submit points)
  document.addEventListener('keypress', function(e){
    if(e.key === 'Enter'){
      // if in game view, trigger add points
      if(document.getElementById('game').style.display === 'block'){
        submitPoints();
        e.preventDefault();
      }
    }
  });
}

// run init on load
window.addEventListener('load', init);
</script>
</body>
</html>
